<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Monitoreo Diario de Encuestas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { background: #0f172a; }
    .card { background: #111827; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .kpi { background: linear-gradient(135deg, #1f2937 0%, #0f172a 100%); }
  </style>
</head>
<body class="text-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <header class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold">Monitoreo Diario de Encuestas</h1>
        <p class="text-gray-400 mt-1">Datos del día actual (se actualiza cada 10 segundos)</p>
      </div>

      <!-- Botones de navegación -->
      <div class="mt-4 md:mt-0 flex gap-3">
        <a href="{% url 'generales:dashboard-consolidado' %}" 
          class="px-5 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-indigo-600 shadow-lg hover:scale-105 transition text-white font-semibold flex items-center gap-2">
          📑 Consolidado General
        </a>
        <a href="{% url 'generales:reporte-censistas' %}" 
          class="px-5 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg hover:scale-105 transition text-white font-semibold flex items-center gap-2">
          📊 Reporte por Fechas
        </a>
      </div>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="card kpi p-6">
        <p class="text-sm text-gray-400">Total encuestas</p>
        <p id="kpi-total" class="text-4xl font-extrabold mt-2">—</p>
      </div>
      <div class="card kpi p-6">
        <p class="text-sm text-gray-400">Total viviendas</p>
        <p id="kpi-viviendas" class="text-4xl font-extrabold mt-2">—</p>
      </div>
      <div class="card kpi p-6">
        <p class="text-sm text-gray-400">Total sectores</p>
        <p id="kpi-sectores" class="text-4xl font-extrabold mt-2">—</p>
      </div>
    </section>
    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Encuestas por censista</h2>
        <div id="chart-censistas" class="w-full h-[360px]"></div>
      </div>
      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Distribución por sectores</h2>
        <div id="chart-sectores" class="w-full h-[360px]"></div>
      </div>
    </section>
   
    <!-- Tabla de convenciones -->
    <section class="card p-4 mt-6">
      <h2 class="text-lg font-semibold mb-2">Convenciones de censistas</h2>
      <table class="min-w-full text-sm text-left text-gray-300">
        <thead class="text-gray-400 border-b border-gray-600">
          <tr>
            <th class="px-4 py-2">ID</th>
            <th class="px-4 py-2">Nombre completo</th>
            <th class="px-4 py-2">Total encuestas</th>
          </tr>
        </thead>
        <tbody id="tabla-convenciones"></tbody>
      </table>
    </section>
    <section class="card p-4 mt-6">
      <h2 class="text-lg font-semibold mb-2">Mapa de Encuestas</h2>
      <!-- Leaflet (si ya lo tienes, puedes omitir estas dos líneas) -->
      <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      />
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

      <!-- Contenedor del mapa -->
      <div id="map" class="w-full h-[520px] rounded-xl mt-6"></div>
    </section>
    <footer class="mt-8 text-xs text-gray-500">
      Reporte generado en tiempo real. Datos de <code>survey_surveyuser</code> y <code>survey_answer</code>.
    </footer>
  </div>

<script>
  // === FUNCIONES DE DATOS ===
  async function fetchData() {
    try {
      const res = await fetch('/dashboard/data/');
      return await res.json();
    } catch (e) {
      console.error("Error obteniendo datos:", e);
      return {};
    }
  }

  // === RENDER INICIAL DE CHARTS ===
  function renderCharts() {
    Plotly.newPlot('chart-censistas', [{ x: [], y: [], type: 'bar' }], {
      paper_bgcolor: '#111827',
      plot_bgcolor: '#111827',
      font: { color: '#e5e7eb' }
    }, { displayModeBar: false });

    Plotly.newPlot('chart-sectores', [{ labels: [], values: [], type: 'pie', hole: .45 }], {
      paper_bgcolor: '#111827',
      font: { color: '#e5e7eb' }
    }, { displayModeBar: false });
  }

  // === ACTUALIZAR INTERFAZ ===
  function updateUI(payload) {
    // KPIs
    document.getElementById('kpi-total').textContent =
      (payload.kpis?.total_encuestas ?? 0).toLocaleString();
    document.getElementById('kpi-viviendas').textContent =
      (payload.kpis?.total_viviendas ?? 0).toLocaleString();
    document.getElementById('kpi-sectores').textContent =
      (payload.kpis?.total_sectores ?? 0).toLocaleString();

    // Gráfica de censistas
    const censistas = payload.censistas || [];
    Plotly.react('chart-censistas', [{
      x: censistas.map(r => String(r.convencion)),
      y: censistas.map(r => r.total_encuestas),
      type: 'bar',
      text: censistas.map(r => r.nombre_completo),
      hoverinfo: 'text+y'
    }], {
      paper_bgcolor: '#111827',
      plot_bgcolor: '#111827',
      font: { color: '#e5e7eb' },
      xaxis: { title: "Censista (ID)", type: "category" },
      yaxis: { title: "Encuestas" }
    }, { displayModeBar: false });

    // Gráfica de sectores
    const sectores = payload.sectores || [];
    Plotly.react('chart-sectores', [{
      labels: sectores.map(r => r.sector),
      values: sectores.map(r => r.total),
      type: 'pie',
      hole: .45
    }], {
      paper_bgcolor: '#111827',
      font: { color: '#e5e7eb' }
    }, { displayModeBar: false });

    // Tabla de convenciones
    const tbody = document.getElementById('tabla-convenciones');
    tbody.innerHTML = '';
    (payload.convenciones || []).forEach(row => {
      tbody.innerHTML += `
        <tr class="border-b border-gray-700">
          <td class="px-4 py-2">${row.convencion}</td>
          <td class="px-4 py-2">${row.nombre_completo}</td>
          <td class="px-4 py-2">${row.total_encuestas}</td>
        </tr>`;
    });
  }

  // === MAPA (CARTO DARK + GEOJSON FIJO) ===
  let map = L.map('map', { attributionControl: false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  maxZoom: 19
}).addTo(map);


  L.control.attribution({ position: 'bottomright' })
    .addAttribution("© Dashboard SMT-ONIC")
    .addTo(map);

  // Cargar archivo fijo GeoJSON
  fetch("/static/base/geo/censo_chia_2025_verificacion.geojson")
    .then(res => res.json())
    .then(data => {
      let geoLayer = L.geoJSON(data, {
        style: {
          color: "#38bdf8",   // borde azul claro
          weight: 2,
          fillColor: "#0ea5e9", // relleno celeste
          fillOpacity: 0.3
        },
        onEachFeature: (feature, layer) => {
          if (feature.properties) {
            let info = Object.entries(feature.properties)
              .map(([k, v]) => `<b>${k}:</b> ${v}`)
              .join("<br>");
            layer.bindPopup(info);
          }
        }
      }).addTo(map);

      map.fitBounds(geoLayer.getBounds());
    })
    .catch(err => console.error("Error cargando GeoJSON:", err));

  // === REFRESCAR DATOS CADA 10 SEGUNDOS ===
  async function refresh() {
    const data = await fetchData();
    updateUI(data);
  }

  // Inicializar
  renderCharts();
  refresh();
  setInterval(refresh, 10000);
</script>
<script>
(function () {
  'use strict';

  // === CONFIG ===
  var DATA_URL    = '/dashboard/data/';
  var GEOJSON_URL = '/static/base/geo/censo_chia_2025_verificacion.geojson';
  var REFRESH_MS  = 10000;

  // === ESTADO INTERNO (encapsulado) ===
  var leafletMap = null;
  var geoLayer   = null;

  // ---------- Utilidades ----------
  function safeNumber(n) {
    return (typeof n === 'number' && isFinite(n)) ? n : 0;
  }

  // ---------- Datos ----------
  function fetchDashboardData() {
    return fetch(DATA_URL, { cache: 'no-store' })
      .then(function (r) { return r.json(); })
      .catch(function (err) {
        console.error('[dashboard] Error fetch:', err);
        return {};
      });
  }

  // ---------- Gráficas ----------
  function initCharts() {
    Plotly.newPlot(
      'chart-censistas',
      [{ x: [], y: [], type: 'bar' }],
      {
        paper_bgcolor: '#111827',
        plot_bgcolor:  '#111827',
        font: { color: '#e5e7eb' },
        xaxis: { title: "Censista (ID)", type: "category" },
        yaxis: { title: "Encuestas" }
      },
      { displayModeBar: false }
    );

    Plotly.newPlot(
      'chart-sectores',
      [{ labels: [], values: [], type: 'pie', hole: .45 }],
      { paper_bgcolor: '#111827', font: { color: '#e5e7eb' } },
      { displayModeBar: false }
    );
  }

  function updateUI(payload) {
    payload = payload || {};
    var kpis = payload.kpis || {};

    // KPIs
    var elTotal     = document.getElementById('kpi-total');
    var elViviendas = document.getElementById('kpi-viviendas');
    var elSectores  = document.getElementById('kpi-sectores');

    if (elTotal)     elTotal.textContent     = safeNumber(kpis.total_encuestas).toLocaleString();
    if (elViviendas) elViviendas.textContent = safeNumber(kpis.total_viviendas).toLocaleString();
    if (elSectores)  elSectores.textContent  = safeNumber(kpis.total_sectores).toLocaleString();

    // Gráfica: censistas
    var censistas = Array.isArray(payload.censistas) ? payload.censistas : [];
    Plotly.react(
      'chart-censistas',
      [{
        x: censistas.map(function (r) { return String(r.convencion); }),
        y: censistas.map(function (r) { return r.total_encuestas; }),
        type: 'bar',
        text: censistas.map(function (r) { return r.nombre_completo; }),
        hoverinfo: 'text+y'
      }],
      {
        paper_bgcolor: '#111827',
        plot_bgcolor:  '#111827',
        font: { color: '#e5e7eb' },
        xaxis: { title: "Censista (ID)", type: "category" },
        yaxis: { title: "Encuestas" }
      },
      { displayModeBar: false }
    );

    // Gráfica: sectores
    var sectores = Array.isArray(payload.sectores) ? payload.sectores : [];
    Plotly.react(
      'chart-sectores',
      [{
        labels: sectores.map(function (r) { return r.sector; }),
        values: sectores.map(function (r) { return r.total; }),
        type: 'pie',
        hole: .45
      }],
      { paper_bgcolor: '#111827', font: { color: '#e5e7eb' } },
      { displayModeBar: false }
    );

    // Tabla: convenciones
    var tbody = document.getElementById('tabla-convenciones');
    if (tbody) {
      var rows = Array.isArray(payload.convenciones) ? payload.convenciones : [];
      var html = '';
      rows.forEach(function (row) {
        html += '' +
          '<tr class="border-b border-gray-700">' +
            '<td class="px-4 py-2">' + (row.convencion || '') + '</td>' +
            '<td class="px-4 py-2">' + (row.nombre_completo || '') + '</td>' +
            '<td class="px-4 py-2">' + (row.total_encuestas || 0) + '</td>' +
          '</tr>';
      });
      tbody.innerHTML = html;
    }
  }
  //---------------------------
  //---------------------------
  // ---------- Mapa ----------
  function initMap() {
    leafletMap = L.map('map', { attributionControl: false });

    // Capas base
    var baseCartoPositron = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
      {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
      }
    );

    var baseCartoDark = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
      }
    );

    var baseEsriImagery = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        attribution: 'Tiles &copy; Esri, Maxar, Earthstar Geographics',
        maxZoom: 20
      }
    );

    // Por defecto: claro y limpio
    baseCartoPositron.addTo(leafletMap);

    // Selector de base
    L.control.layers(
      {
        '🌐 Carto Positron (claro)': baseCartoPositron,
        '🌑 Carto Dark': baseCartoDark,
        '🛰️ Esri World Imagery': baseEsriImagery
      },
      null,
      { collapsed: false }
    ).addTo(leafletMap);

    // Atribución propia
    L.control.attribution({ position: 'bottomright', attributionControl: false })
      .addAttribution('© Dashboard SMT-ONIC')
      .addTo(leafletMap);

    // Cargar GeoJSON (una sola vez)
    fetch(GEOJSON_URL, { cache: 'no-store' })
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (geoLayer) { leafletMap.removeLayer(geoLayer); }
        geoLayer = L.geoJSON(data, {
          style: function () {
            return { color: '#2563eb', weight: 2, fillColor: '#3b82f6', fillOpacity: 0.25 };
          },
          onEachFeature: function (feature, layer) {
            var props = feature && feature.properties;
            if (props) {
              var info = '';
              Object.keys(props).forEach(function (k) {
                info += '<b>' + k + ':</b> ' + props[k] + '<br>';
              });
              if (info) layer.bindPopup(info);
            }
          }
        }).addTo(leafletMap);

        // Auto-zoom seguro
        try {
          var bounds = geoLayer.getBounds();
          if (bounds && bounds.isValid && bounds.isValid()) {
            leafletMap.fitBounds(bounds, { padding: [30, 30] });
          } else {
            leafletMap.setView([4.65, -74.1], 10); // Bogotá fallback
          }
        } catch (e) {
          console.warn('[map] Bounds inválidos, usando fallback:', e);
          leafletMap.setView([4.65, -74.1], 10);
        }
      })
      .catch(function (err) {
        console.error('[map] Error GeoJSON:', err);
        leafletMap.setView([4.65, -74.1], 10);
      });
  }

  // ---------- Loop de refresco ----------
  function refreshLoop() {
    fetchDashboardData().then(updateUI);
  }

  // ---------- Inicio ----------
  document.addEventListener('DOMContentLoaded', function () {
    initCharts();
    initMap();
    refreshLoop();
    setInterval(refreshLoop, REFRESH_MS);
  });
})();
</script>

</body>
</html>
