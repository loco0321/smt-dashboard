<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Monitoreo Diario de Encuestas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { background: #0f172a; }
    .card { background: #111827; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .kpi { background: linear-gradient(135deg, #1f2937 0%, #0f172a 100%); }
  </style>
</head>
<body class="text-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <header class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold">Monitoreo Diario de Encuestas</h1>
        <p class="text-gray-400 mt-1">Datos del día actual (se actualiza cada 10 segundos)</p>
      </div>

      <!-- Botones de navegación -->
      <div class="mt-4 md:mt-0 flex gap-3">
        <a href="{% url 'generales:dashboard-consolidado' %}" 
          class="px-5 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-indigo-600 shadow-lg hover:scale-105 transition text-white font-semibold flex items-center gap-2">
          📑 Consolidado General
        </a>
        <a href="{% url 'generales:reporte-censistas' %}" 
          class="px-5 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg hover:scale-105 transition text-white font-semibold flex items-center gap-2">
          📊 Reporte por Fechas
        </a>
      </div>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="card kpi p-6">
        <p class="text-sm text-gray-400">Total encuestas</p>
        <p id="kpi-total" class="text-4xl font-extrabold mt-2">—</p>
      </div>
      <div class="card kpi p-6">
        <p class="text-sm text-gray-400">Total viviendas</p>
        <p id="kpi-viviendas" class="text-4xl font-extrabold mt-2">—</p>
      </div>
      <div class="card kpi p-6">
        <p class="text-sm text-gray-400">Total sectores</p>
        <p id="kpi-sectores" class="text-4xl font-extrabold mt-2">—</p>
      </div>
    </section>
    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Encuestas por censista</h2>
        <div id="chart-censistas" class="w-full h-[360px]"></div>
      </div>
      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Distribución por sectores</h2>
        <div id="chart-sectores" class="w-full h-[360px]"></div>
      </div>
    </section>
   
    <!-- Tabla de convenciones -->
    <section class="card p-4 mt-6">
      <h2 class="text-lg font-semibold mb-2">Convenciones de censistas</h2>
      <table class="min-w-full text-sm text-left text-gray-300">
        <thead class="text-gray-400 border-b border-gray-600">
          <tr>
            <th class="px-4 py-2">ID</th>
            <th class="px-4 py-2">Nombre completo</th>
            <th class="px-4 py-2">Total encuestas</th>
          </tr>
        </thead>
        <tbody id="tabla-convenciones"></tbody>
      </table>
    </section>
    <section class="card p-4 mt-6">
      <h2 class="text-lg font-semibold mb-2">Mapa de Encuestas</h2>
      <!-- Leaflet (si ya lo tienes, puedes omitir estas dos líneas) -->
      <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      />
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

      <!-- Contenedor del mapa -->
      <div id="map" class="w-full h-[520px] rounded-xl mt-6"></div>
    </section>
    <footer class="mt-8 text-xs text-gray-500">
      Reporte generado en tiempo real. Datos de <code>survey_surveyuser</code> y <code>survey_answer</code>.
    </footer>
  </div>

  <script>
    async function fetchData() {
      const res = await fetch('/dashboard/data/');
      return res.json();
    }

    function renderOnce() {
      Plotly.newPlot('chart-censistas', [{x: [], y: [], type: 'bar'}],
        { paper_bgcolor:'#111827', plot_bgcolor:'#111827', font:{color:'#e5e7eb'} },
        {displayModeBar: false});
      Plotly.newPlot('chart-sectores', [{labels: [], values: [], type: 'pie', hole:.45}],
        { paper_bgcolor:'#111827', font:{color:'#e5e7eb'} },
        {displayModeBar: false});
    }

    function updateUI(payload) {
      // KPIs
      document.getElementById('kpi-total').textContent = (payload.kpis.total_encuestas ?? 0).toLocaleString();
      document.getElementById('kpi-viviendas').textContent = (payload.kpis.total_viviendas ?? 0).toLocaleString();
      document.getElementById('kpi-sectores').textContent = (payload.kpis.total_sectores ?? 0).toLocaleString();

      // Gráfica de censistas
      const censistas = payload.censistas || [];
      Plotly.react('chart-censistas', [{
        x: censistas.map(r => String(r.convencion)),
        y: censistas.map(r => r.total_encuestas),
        type: 'bar',
        text: censistas.map(r => r.nombre_completo),
        hoverinfo: 'text+y'
      }], {
        paper_bgcolor:'#111827',
        plot_bgcolor:'#111827',
        font:{color:'#e5e7eb'},
        xaxis:{title:"Censista (ID)", type:"category"},
        yaxis:{title:"Encuestas"}
      }, {displayModeBar:false});

      // Gráfica de sectores
      const sectores = payload.sectores || [];
      Plotly.react('chart-sectores', [{
        labels: sectores.map(r => r.sector),
        values: sectores.map(r => r.total),
        type: 'pie',
        hole:.45
      }], {
        paper_bgcolor:'#111827',
        font:{color:'#e5e7eb'}
      }, {displayModeBar:false});

      // Tabla de convenciones
      const tbody = document.getElementById('tabla-convenciones');
      tbody.innerHTML = '';
      (payload.convenciones || []).forEach(row => {
        tbody.innerHTML += `
          <tr class="border-b border-gray-700">
            <td class="px-4 py-2">${row.convencion}</td>
            <td class="px-4 py-2">${row.nombre_completo}</td>
            <td class="px-4 py-2">${row.total_encuestas}</td>
          </tr>`;
      });
    }

    renderOnce();
    refresh();
    setInterval(refresh, 10000);

    async function refresh() {
      try {
        const data = await fetchData();
        updateUI(data);
      } catch (e) {
        console.error(e);
      }
    }
  </script>
  
  



<script>
  // === FUNCIONES GENERALES ===
  async function fetchData() {
    const res = await fetch('/dashboard/data/');
    return res.json();
  }

  function renderCharts() {
    Plotly.newPlot('chart-censistas', [{x: [], y: [], type: 'bar'}],
      { paper_bgcolor:'#111827', plot_bgcolor:'#111827', font:{color:'#e5e7eb'} },
      { displayModeBar: false });
    Plotly.newPlot('chart-sectores', [{labels: [], values: [], type: 'pie', hole:.45}],
      { paper_bgcolor:'#111827', font:{color:'#e5e7eb'} },
      { displayModeBar: false });
  }

  // === MAPA ===
  let map = L.map('map', { attributionControl: false });
  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 20 }
  ).addTo(map);

  // Atribución personalizada
  L.control.attribution({position:'bottomright'})
    .addAttribution("© Dashboard SMT-ONIC")
    .addTo(map);

  // Capas
  let layerTotal = L.layerGroup().addTo(map);
  let layerViviendas = L.layerGroup().addTo(map);
  let layerSectores = L.layerGroup().addTo(map);

  L.control.layers(null, {
    "Total Encuestas": layerTotal,
    "Viviendas": layerViviendas,
    "Sectores": layerSectores
  }, {collapsed:false}).addTo(map);

  // Icono especial para viviendas
  const houseIcon = L.divIcon({
    html: "🏠",
    className: "text-2xl",
    iconSize: [24,24],
    iconAnchor: [12,12]
  });

  // ⚡ Para evitar zoom en cada refresh
  let firstFit = true;
  let lastMarkers = [];

  function updateUI(payload) {
    // === KPIs ===
    document.getElementById('kpi-total').textContent = (payload.kpis.total_encuestas ?? 0).toLocaleString();
    document.getElementById('kpi-viviendas').textContent = (payload.kpis.total_viviendas ?? 0).toLocaleString();
    document.getElementById('kpi-sectores').textContent = (payload.kpis.total_sectores ?? 0).toLocaleString();

    // === Gráfica censistas ===
    const censistas = payload.censistas || [];
    Plotly.react('chart-censistas', [{
      x: censistas.map(r => String(r.convencion)),
      y: censistas.map(r => r.total_encuestas),
      type: 'bar',
      text: censistas.map(r => r.nombre_completo),
      hoverinfo: 'text+y'
    }], {
      paper_bgcolor:'#111827',
      plot_bgcolor:'#111827',
      font:{color:'#e5e7eb'},
      xaxis:{title:"Censista (ID)", type:"category"},
      yaxis:{title:"Encuestas"}
    }, {displayModeBar:false});

    // === Gráfica sectores ===
    const sectores = payload.sectores || [];
    Plotly.react('chart-sectores', [{
      labels: sectores.map(r => r.sector),
      values: sectores.map(r => r.total),
      type: 'pie',
      hole:.45
    }], {
      paper_bgcolor:'#111827',
      font:{color:'#e5e7eb'}
    }, {displayModeBar:false});

    // === Tabla convenciones ===
    const tbody = document.getElementById('tabla-convenciones');
    tbody.innerHTML = '';
    (payload.convenciones || []).forEach(row => {
      tbody.innerHTML += `
        <tr class="border-b border-gray-700">
          <td class="px-4 py-2">${row.convencion}</td>
          <td class="px-4 py-2">${row.nombre_completo}</td>
          <td class="px-4 py-2">${row.total_encuestas}</td>
        </tr>`;
    });

    // === MAPA ===
    layerTotal.clearLayers();
    layerViviendas.clearLayers();
    layerSectores.clearLayers();
    let markers = [];

    // Total encuestas
    (payload.geo || []).forEach(r => {
      if(r.lat && r.lng){
        let m = L.circleMarker([r.lat, r.lng], {
          radius: 5,
          color: "#38bdf8",
          fillColor: "#0ea5e9",
          fillOpacity: .8
        }).bindPopup(`<b>Encuesta:</b> ${r.survey_user_id}`);
        m.addTo(layerTotal);
        markers.push([r.lat, r.lng]);
      }
    });

    // Viviendas
    (payload.viviendas_geo || []).forEach(r => {
      if(r.lat && r.lng){
        let m = L.marker([r.lat, r.lng], {icon: houseIcon})
          .bindPopup(`<b>Vivienda:</b> ${r.vivienda}`);
        m.addTo(layerViviendas);
        markers.push([r.lat, r.lng]);
      }
    });

    // Sectores
    let sectoresDict = {};
    (payload.sectores_geo || []).forEach(r => {
      if(!sectoresDict[r.sector]) sectoresDict[r.sector] = [];
      sectoresDict[r.sector].push([r.lat, r.lng]);
    });
    for(const [sector, pts] of Object.entries(sectoresDict)){
      if(pts.length >= 3){
        L.polygon(pts, {
          color:"#f97316",
          weight:2,
          fillColor:"#facc15",
          fillOpacity:.3
        }).addTo(layerSectores);
      }
      pts.forEach(p=>{
        L.circleMarker(p, {
          radius: 4,
          color: "#f59e0b",
          fillColor: "#fbbf24",
          fillOpacity:.9
        }).bindPopup(`<b>Sector:</b> ${sector}`).addTo(layerSectores);
        markers.push(p);
      });
    }

    // Ajustar zoom solo primera vez
   if(firstFit){
    zoomToCluster(markers);
    firstFit = false;
  }

    lastMarkers = markers;
  }

  // === BOTÓN "RECENTRAR" ===
  const recenterBtn = L.control({position:'topleft'});
  recenterBtn.onAdd = function(){
    let div = L.DomUtil.create('div','');
    div.innerHTML = `
      <button id="btn-recenter" 
        class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg shadow-lg">
        🔍 Recentrar
      </button>`;
    return div;
  };
  recenterBtn.addTo(map);

  document.addEventListener("click", e=>{
    if(e.target && e.target.id==="btn-recenter" && lastMarkers.length>0){
      zoomToCluster(lastMarkers);

    }
  });

  // === REFRESCAR DATOS ===
  renderCharts();
  async function refresh(){ try{ updateUI(await fetchData()); } catch(e){ console.error(e); } }
  refresh();
  setInterval(refresh, 10000);

  // === FUNCIÓN PARA HACER ZOOM A LA ZONA PRINCIPAL ===
function zoomToCluster(markers){
  if(markers.length === 0){
    map.setView([4.65, -74.1], 8); // Bogotá por defecto
    return;
  }

  // Calcular centro promedio
  let latSum = 0, lngSum = 0;
  markers.forEach(p => { latSum += p[0]; lngSum += p[1]; });
  let center = [latSum/markers.length, lngSum/markers.length];

  // Calcular dispersión aproximada
  let maxDist = 0;
  markers.forEach(p => {
    let dLat = p[0] - center[0];
    let dLng = p[1] - center[1];
    let dist = Math.sqrt(dLat*dLat + dLng*dLng);
    if(dist > maxDist) maxDist = dist;
  });

  // Ajustar zoom en función de la dispersión
  let zoom = 14; // por defecto cercano
  if(maxDist > 0.5) zoom = 8;   // muy disperso (ej: varios municipios)
  else if(maxDist > 0.1) zoom = 11; // moderado
  else if(maxDist > 0.05) zoom = 13;

  map.setView(center, zoom);
}

</script>



</body>
</html>
